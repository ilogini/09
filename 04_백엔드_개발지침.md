# 공구모아 — 백엔드 개발 지침

---

## 1. 기술 스택

| 구분 | 기술 | 버전(권장) |
|------|------|-----------|
| 언어 | Python | 3.11+ |
| 프레임워크 | FastAPI | 0.100+ |
| ORM | SQLAlchemy 2.0 | 2.0+ |
| 마이그레이션 | Alembic | — |
| DB | PostgreSQL | 15+ |
| 캐시 | Redis | 7+ |
| 인증 | JWT (PyJWT) + OAuth2 | — |
| 작업 큐 | Celery + Redis (브로커) | — |
| 파일 저장 | AWS S3 (boto3) | — |
| 알림 | Firebase Admin SDK + 카카오 알림톡 API | — |
| API 문서 | Swagger (FastAPI 자동 생성) | — |
| 배포 | AWS EC2 또는 Railway | — |

---

## 2. 프로젝트 구조

```
app/
├── main.py                 # FastAPI 앱 진입점
├── config.py               # 환경변수, 설정
├── database.py             # DB 연결, 세션 관리
│
├── models/                 # SQLAlchemy 모델 (DB 테이블)
│   ├── user.py             # 사용자 (구매자, 인플루언서)
│   ├── gonggu.py           # 공구
│   ├── category.py         # 라이프스타일 카테고리
│   ├── subscription.py     # 구독
│   ├── review.py           # 후기
│   ├── tracking.py         # 클릭 트래킹
│   ├── notification.py     # 알림
│   ├── point.py            # 포인트/쿠폰
│   ├── banner.py           # 배너/광고
│   └── settlement.py       # 정산
│
├── schemas/                # Pydantic 스키마 (요청/응답 형식)
│   ├── user.py
│   ├── gonggu.py
│   ├── category.py
│   └── ...
│
├── routers/                # API 라우터 (엔드포인트)
│   ├── auth.py             # 인증 (로그인, 회원가입, OAuth)
│   ├── users.py            # 사용자 관리
│   ├── gonggu.py           # 공구 CRUD, 탐색
│   ├── categories.py       # 카테고리
│   ├── influencers.py      # 인플루언서
│   ├── subscriptions.py    # 구독
│   ├── calendar.py         # 캘린더 일정
│   ├── reviews.py          # 후기
│   ├── tracking.py         # 클릭 트래킹
│   ├── notifications.py    # 알림
│   ├── search.py           # 검색
│   ├── admin.py            # 관리자 기능
│   └── upload.py           # 파일 업로드
│
├── services/               # 비즈니스 로직
│   ├── auth_service.py
│   ├── gonggu_service.py
│   ├── tracking_service.py
│   ├── notification_service.py
│   ├── settlement_service.py
│   └── search_service.py
│
├── core/                   # 핵심 유틸리티
│   ├── security.py         # JWT 생성/검증, 비밀번호 해싱
│   ├── dependencies.py     # FastAPI 의존성 (현재 사용자, 권한 체크)
│   ├── permissions.py      # 역할 기반 권한 (구매자/인플루언서/관리자)
│   └── exceptions.py       # 커스텀 예외
│
├── tasks/                  # Celery 비동기 작업
│   ├── notification_tasks.py   # 알림 발송 (푸시, 알림톡)
│   ├── tracking_tasks.py       # 클릭 통계 집계
│   └── settlement_tasks.py     # 정산 처리
│
└── tests/                  # 테스트
    ├── test_auth.py
    ├── test_gonggu.py
    └── ...
```

---

## 3. 데이터베이스 설계 핵심 테이블

### 3.1 사용자 (users)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| email | VARCHAR(255) | 고유, 로그인용 |
| password_hash | VARCHAR(255) | bcrypt 해시 (소셜 로그인은 NULL) |
| nickname | VARCHAR(50) | 닉네임 |
| role | ENUM | `buyer`, `influencer`, `admin` |
| status | ENUM | `active`, `suspended`, `pending` |
| social_provider | VARCHAR(20) | kakao, naver, google, apple (NULL이면 이메일 가입) |
| social_id | VARCHAR(255) | 소셜 로그인 고유 ID |
| profile_image | VARCHAR(500) | S3 URL |
| created_at | TIMESTAMP | 가입일 |

### 3.2 인플루언서 프로필 (influencer_profiles)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| user_id | UUID | FK → users |
| bio | TEXT | 소개글 |
| banner_image | VARCHAR(500) | 배너 이미지 URL |
| instagram_url | VARCHAR(500) | 인스타 링크 |
| tiktok_url | VARCHAR(500) | 틱톡 링크 |
| is_verified | BOOLEAN | 심사 승인 여부 |
| subscriber_count | INTEGER | 구독자 수 (캐시) |

### 3.3 공구 (gonggus)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| influencer_id | UUID | FK → users |
| title | VARCHAR(200) | 공구 제목 |
| description | TEXT | 상세 설명 |
| original_price | INTEGER | 정가 (원) |
| gonggu_price | INTEGER | 공구가 (원) |
| discount_rate | DECIMAL | 할인율 |
| status | ENUM | `scheduled`, `active`, `closed` |
| open_at | TIMESTAMP | 오픈 일시 |
| close_at | TIMESTAMP | 마감 일시 |
| external_url | VARCHAR(1000) | 외부 구매 링크 (핵심) |
| thumbnail | VARCHAR(500) | 대표 이미지 URL |
| click_count | INTEGER | 클릭 수 (캐시) |
| created_at | TIMESTAMP | 등록일 |

### 3.4 카테고리 (categories)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| parent_id | UUID | FK → categories (NULL이면 최상위 그룹) |
| name | VARCHAR(50) | 카테고리명 |
| icon | VARCHAR(500) | 아이콘 URL |
| sort_order | INTEGER | 정렬 순서 |

카테고리 구조: `기혼/가정(parent)` → `육아/키즈(child)`

### 3.5 공구-카테고리 매핑 (gonggu_categories)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| gonggu_id | UUID | FK → gonggus |
| category_id | UUID | FK → categories |

하나의 공구는 최대 2개 카테고리에 등록 가능 (비즈니스 로직으로 제한)

### 3.6 구독 (subscriptions)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| buyer_id | UUID | FK → users |
| influencer_id | UUID | FK → users |
| notify_enabled | BOOLEAN | 알림 수신 여부 |
| created_at | TIMESTAMP | 구독일 |

### 3.7 클릭 트래킹 (click_trackings)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| gonggu_id | UUID | FK → gonggus |
| user_id | UUID | FK → users (NULL이면 비로그인) |
| ip_address | VARCHAR(45) | IP |
| user_agent | TEXT | 브라우저 정보 |
| referer | VARCHAR(1000) | 유입 경로 |
| clicked_at | TIMESTAMP | 클릭 시점 |

이 테이블이 수익(CPC)의 근거가 되므로 정확한 기록이 중요하다.

### 3.8 후기 (reviews)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| gonggu_id | UUID | FK → gonggus |
| user_id | UUID | FK → users |
| rating | SMALLINT | 별점 (1~5) |
| content | TEXT | 후기 내용 |
| images | JSON | 이미지 URL 배열 |
| created_at | TIMESTAMP | 작성일 |

---

## 4. API 설계 규칙

### 4.1 URL 구조

```
/api/v1/{도메인}/{리소스}
```

| 메서드 | 패턴 | 설명 |
|--------|------|------|
| GET | `/api/v1/gonggus` | 공구 목록 조회 |
| GET | `/api/v1/gonggus/{id}` | 공구 상세 조회 |
| POST | `/api/v1/gonggus` | 공구 등록 (인플루언서) |
| PUT | `/api/v1/gonggus/{id}` | 공구 수정 |
| DELETE | `/api/v1/gonggus/{id}` | 공구 삭제 |

### 4.2 주요 API 목록

#### 인증

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/v1/auth/signup` | 회원가입 |
| POST | `/api/v1/auth/login` | 로그인 → JWT 발급 |
| POST | `/api/v1/auth/refresh` | 토큰 갱신 |
| POST | `/api/v1/auth/social/{provider}` | 소셜 로그인 (kakao/naver/google/apple) |

#### 공구

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/v1/gonggus` | 공구 목록 (필터: 카테고리, 상태, 정렬) |
| GET | `/api/v1/gonggus/{id}` | 공구 상세 |
| POST | `/api/v1/gonggus` | 공구 등록 |
| PUT | `/api/v1/gonggus/{id}` | 공구 수정 |
| GET | `/api/v1/gonggus/active` | 진행중 공구 |
| GET | `/api/v1/gonggus/upcoming` | 오픈 예정 공구 |
| GET | `/api/v1/gonggus/closing-soon` | 마감 임박 공구 |

#### 트래킹 (핵심)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/v1/tracking/click` | 구매링크 클릭 기록 |
| GET | `/api/v1/tracking/stats/{gonggu_id}` | 공구별 클릭 통계 |
| GET | `/api/v1/go/{gonggu_id}` | 트래킹 리다이렉트 URL |

#### 구독

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/v1/subscriptions/{influencer_id}` | 구독 |
| DELETE | `/api/v1/subscriptions/{influencer_id}` | 구독 해제 |
| GET | `/api/v1/subscriptions/feed` | 구독 피드 |

#### 검색

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/v1/search` | 통합 검색 (?q=키워드&type=all/gonggu/influencer) |

### 4.3 응답 형식

```json
// 성공 (단일)
{
  "id": "uuid",
  "title": "로봇청소기 공구",
  "gonggu_price": 199000,
  ...
}

// 성공 (목록 + 페이지네이션)
{
  "items": [...],
  "total": 150,
  "page": 1,
  "size": 20,
  "pages": 8
}

// 에러
{
  "detail": "공구를 찾을 수 없습니다",
  "code": "GONGGU_NOT_FOUND"
}
```

### 4.4 페이지네이션

```
GET /api/v1/gonggus?page=1&size=20&sort=created_at&order=desc
```

- `page`: 페이지 번호 (1부터 시작)
- `size`: 페이지당 항목 수 (기본 20, 최대 100)
- `sort`: 정렬 기준
- `order`: `asc` 또는 `desc`

---

## 5. 인증 / 권한

### 5.1 JWT 구조

```
Access Token  — 유효기간 30분, API 요청 시 사용
Refresh Token — 유효기간 7일, Access Token 갱신용, DB 또는 Redis 저장
```

### 5.2 역할 기반 권한

| 역할 | 접근 가능 영역 |
|------|--------------|
| `buyer` | 공통 + 구매자 마이페이지 |
| `influencer` | 공통 + 구매자 기능 + 인플루언서 대시보드 |
| `admin` | 전체 |

```python
# 의존성 주입 예시
@router.post("/gonggus")
async def create_gonggu(
    data: GongguCreate,
    current_user: User = Depends(get_current_influencer)  # 인플루언서만 접근
):
    ...
```

### 5.3 소셜 로그인 흐름

```
1. 프론트에서 소셜 로그인 버튼 클릭
2. 소셜 서비스 인증 페이지로 리다이렉트
3. 인증 완료 → 콜백 URL로 authorization code 전달
4. 백엔드에서 code → access token 교환 → 사용자 정보 조회
5. 기존 회원이면 로그인, 신규면 자동 가입
6. JWT 발급 → 프론트로 전달
```

---

## 6. 클릭 트래킹 시스템 (핵심 수익 로직)

이 플랫폼의 수익 근거이므로 정확하고 신뢰할 수 있어야 한다.

### 6.1 트래킹 플로우

```
사용자가 "구매하러 가기" 클릭
  → 프론트: POST /api/v1/tracking/click (gonggu_id 전송)
  → 백엔드: click_trackings 테이블에 기록
  → 백엔드: gonggus.click_count 증가 (Redis 캐시)
  → 프론트: 외부 URL로 이동 (window.open)
```

### 6.2 리다이렉트 방식 (대안)

```
GET /api/v1/go/{gonggu_id}
  → 클릭 기록
  → 302 Redirect → 외부 구매 URL
    (utm_source=gonggumoa&utm_campaign={gonggu_id} 파라미터 추가)
```

### 6.3 부정 클릭 방지

- 동일 사용자 + 동일 공구: 5분 내 중복 클릭 무시
- 동일 IP 대량 클릭 감지 → 경고 플래그
- 비로그인 클릭도 IP 기반으로 기록

---

## 7. 알림 시스템

### 7.1 알림 트리거

| 이벤트 | 대상 | 수단 |
|--------|------|------|
| 구독 인플루언서 공구 등록 | 구독자 | 푸시, 알림톡 |
| 공구 오픈 N분 전 | 알림 설정 사용자 | 푸시, 알림톡 |
| 마감 임박 (1시간 전) | 찜한 사용자 | 푸시 |
| 인플루언서 심사 결과 | 인플루언서 | 이메일, 알림톡 |
| 정산 완료 | 인플루언서 | 이메일, 알림톡 |

### 7.2 구현

- 예약 알림: Celery Beat (스케줄러)로 주기적 체크
- 즉시 알림: API 호출 시점에 Celery 태스크 큐에 추가
- FCM: 푸시 알림 발송
- 카카오 알림톡: 카카오 비즈니스 API 연동

---

## 8. 검색

### 8.1 초기: PostgreSQL Full-Text Search

```sql
-- tsvector 컬럼 추가
ALTER TABLE gonggus ADD COLUMN search_vector tsvector;

-- 인덱스 생성
CREATE INDEX idx_gonggu_search ON gonggus USING GIN(search_vector);

-- 검색 쿼리
SELECT * FROM gonggus
WHERE search_vector @@ to_tsquery('korean', '로봇청소기');
```

### 8.2 확장: Elasticsearch

트래픽 증가 시 Elasticsearch로 전환. 검색 서비스 레이어만 교체하면 되도록 `services/search_service.py`에 추상화해둔다.

---

## 9. 파일 업로드

### 9.1 흐름

```
프론트 → POST /api/v1/upload/image (multipart/form-data)
  → 백엔드: 이미지 검증 (크기, 형식)
  → 백엔드: S3 업로드
  → 응답: { "url": "https://cdn.gonggu-moa.com/images/xxx.webp" }
```

### 9.2 규칙

- 허용 형식: jpg, png, webp, gif
- 최대 크기: 5MB (이미지), 배너는 10MB
- 이미지 리사이징: 업로드 시 썸네일 자동 생성 (Pillow)
- 저장 경로: `s3://bucket/images/{year}/{month}/{uuid}.webp`

---

## 10. 환경 변수

```env
# .env
DATABASE_URL=postgresql://user:pass@localhost:5432/gonggumoa
REDIS_URL=redis://localhost:6379/0

# JWT
JWT_SECRET_KEY=your-secret-key
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# AWS
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx
AWS_S3_BUCKET=gonggumoa-uploads
AWS_CLOUDFRONT_DOMAIN=cdn.gonggu-moa.com

# 소셜 로그인
KAKAO_CLIENT_ID=xxx
KAKAO_CLIENT_SECRET=xxx
NAVER_CLIENT_ID=xxx
NAVER_CLIENT_SECRET=xxx
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx

# 알림
FIREBASE_CREDENTIALS_PATH=./firebase-credentials.json
KAKAO_ALIMTALK_API_KEY=xxx

# 서버
API_HOST=0.0.0.0
API_PORT=8000
CORS_ORIGINS=["http://localhost:3000","https://gonggu-moa.com"]
```

---

## 11. 배포

### 11.1 로컬 개발

```bash
# 가상환경
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 의존성 설치
pip install -r requirements.txt

# DB 마이그레이션
alembic upgrade head

# 서버 실행
uvicorn app.main:app --reload --port 8000

# API 문서 확인
# http://localhost:8000/docs
```

### 11.2 프로덕션

| 항목 | 설정 |
|------|------|
| ASGI 서버 | Uvicorn + Gunicorn (워커 다중화) |
| 프로세스 관리 | systemd 또는 Docker |
| HTTPS | Nginx 리버스 프록시 + Let's Encrypt |
| DB | AWS RDS (PostgreSQL) |
| Redis | AWS ElastiCache |

---

## 12. 코딩 규칙

| 항목 | 규칙 |
|------|------|
| 파일명 | snake_case (`gonggu_service.py`) |
| 클래스 | PascalCase (`GongguCreate`) |
| 함수/변수 | snake_case (`get_active_gonggus`) |
| 상수 | UPPER_SNAKE_CASE (`MAX_CATEGORIES_PER_GONGGU = 2`) |
| Pydantic 스키마 | 요청: `XxxCreate`, `XxxUpdate` / 응답: `XxxResponse`, `XxxListResponse` |
| 라우터 태그 | API 문서 그룹화용 (`tags=["gonggus"]`) |
| 커밋 | Conventional Commits (`feat:`, `fix:`, `refactor:` 등) |
